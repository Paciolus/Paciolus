# Backup Integrity Verification Procedure

**Version:** 1.0
**Document Classification:** Internal
**Owner:** CISO / CTO
**Effective Date:** 2026-02-27
**Last Updated:** 2026-02-27
**Next Review:** 2026-08-27
**Controls:** S1.5 / CC4.2 — Backup integrity verification / Detective controls

---

## 1. Purpose

This procedure defines how Paciolus verifies monthly that the PostgreSQL database backup infrastructure is healthy and that backups are current. It supports the BCP/DR §7.1 control: "Backup integrity check — monthly — automated check with alert on failure."

---

## 2. Backup Architecture

Paciolus uses Render-managed PostgreSQL with the following backup strategy:

| Backup Type | Frequency | Managed By | Recovery Capability |
|-------------|-----------|------------|---------------------|
| **Automated daily backups** | Daily | Render | Point-in-time restore (PITR) within 7-day window |
| **WAL archiving** | Continuous | Render | PITR down to seconds |
| **Pre-migration snapshot** | On demand (manual) | Engineering | Alembic migration rollback |
| **Restore test** | Semi-annual | Engineering (CEO) | Full verification of restore procedure |

### 2.1 Backup Limitation: No Direct File Access

Render PostgreSQL is a fully managed service. Backup files are stored in Render's internal infrastructure and are not directly downloadable by customers. This means:

- ✅ **We can verify**: backup system health (instance status, WAL archiving)
- ✅ **We can verify**: backup recency (if Render API exposes timestamp)
- ❌ **We cannot compute**: SHA-256 checksums of backup files directly
- ✅ **Equivalent verification**: The semi-annual DR restore test (Sprint 452 / `dr-test-YYYY-QN.md`) provides file-level integrity verification by actually restoring the backup

**Compensating control:** The combination of (a) monthly Render API health checks and (b) semi-annual restore tests provides equivalent assurance to SHA-256 checksums at the file level.

---

## 3. Monthly Automated Check

### 3.1 Script

**File:** `scripts/verify_backup_integrity.py`

**What it checks:**
1. **Render API instance status** (`GET /v1/postgres/{id}`) — verifies `status == "available"`
2. **Render API backup metadata** (`GET /v1/postgres/{id}/backup`) — attempts to retrieve last backup timestamp; handles HTTP 404 gracefully if not exposed
3. **DB liveness probe** (optional, if `DATABASE_URL` set) — runs `SELECT 1` and queries `pg_stat_archiver` for WAL archive recency and failure count

**Pass criteria:**
- Render instance status = `available`
- Backup age ≤ 25 hours (if backup timestamp is available)
- DB responsive (if `DATABASE_URL` provided)
- WAL archive failures = 0 (if DB probe enabled)

**Fail criteria:** Any check fails. GitHub issue created automatically.

### 3.2 Running Manually

```bash
# Minimum: Render API checks only
RENDER_API_KEY=rnd_... \
RENDER_POSTGRES_ID=postgres-... \
python scripts/verify_backup_integrity.py --save

# With DB liveness probe (recommended; use read-only credentials)
RENDER_API_KEY=rnd_... \
RENDER_POSTGRES_ID=postgres-... \
DATABASE_URL=postgresql://readonly_user:pass@host/db \
python scripts/verify_backup_integrity.py --save
```

**Output:** Evidence written to `docs/08-internal/soc2-evidence/s1/backup-integrity-YYYYMM.txt`

**Exit codes:** `0` = PASS, `1` = FAIL, `2` = configuration error (missing env vars)

### 3.3 GitHub Actions Automation

**Workflow:** `.github/workflows/backup-integrity-check.yml`

**Schedule:** 1st of each month, 06:00 UTC

**Required GitHub Secrets:**

| Secret | Value | Notes |
|--------|-------|-------|
| `RENDER_API_KEY` | Render personal API token | Read-only scope is sufficient |
| `RENDER_POSTGRES_ID` | PostgreSQL service ID | Found in Render dashboard URL: `/postgres/{id}` |
| `DATABASE_URL_READONLY` | Read-only PostgreSQL URL | Optional; use a dedicated read-only DB user |

**CEO action to set up:** Navigate to GitHub → repository → Settings → Secrets and variables → Actions → New repository secret. Add each secret above.

**Artifact retention:** 365 days (1 year) as GitHub Actions artifacts, satisfying SOC 2 evidence retention.

---

## 4. Evidence Filing

Monthly output is filed in two locations:

1. **Primary:** `docs/08-internal/soc2-evidence/s1/backup-integrity-YYYYMM.txt` (auto-generated by `--save`)
2. **GitHub Actions artifact:** `backup-integrity-YYYYMM` (retained 365 days; accessible via GitHub UI)

**Annual summary:** At year-end, create `docs/08-internal/soc2-evidence/s1/backup-integrity-summary-YYYY.md` with a table of all monthly results:

```markdown
| Month   | Status | Operator | Notes |
|---------|--------|----------|-------|
| 2026-03 | PASS   | [initials] | First automated run |
| 2026-04 | PASS   | [initials] | |
```

---

## 5. Response Procedures

### 5.1 PASS Result

No action required. Evidence is filed automatically. Review the artifact monthly to confirm the check ran.

### 5.2 FAIL Result

A GitHub issue is automatically created with label `dr-failure`. The CISO must:

1. **Acknowledge** the issue within 4 hours (business hours)
2. **Diagnose** the failure:
   - Check Render status page (`status.render.com`) for platform incidents
   - Check Render dashboard → your PostgreSQL instance → backup history
   - If DB liveness probe failed: verify application connectivity to database
3. **Escalate** if backup is confirmed missing/stale for > 25 hours:
   - Activate IRP P1 response (see `docs/04-compliance/INCIDENT_RESPONSE_PLAN.md`)
   - Contact Render support with backup continuity concern
4. **Resolve** the root cause before closing the GitHub issue
5. **File** post-mortem note in the issue and in the evidence file

### 5.3 Alert Thresholds

| Condition | Severity | Response SLA |
|-----------|----------|-------------|
| Render instance not available | HIGH | Immediate (IRP P1) |
| Backup age > 25 hours | HIGH | 4-hour business hours |
| WAL archive failures > 0 | MEDIUM | Next business day |
| DB liveness probe failure | HIGH | Immediate (IRP P1) |

---

## 6. Relationship to DR Restore Test

This monthly check and the semi-annual DR restore test are **complementary**:

| Control | Frequency | What It Verifies |
|---------|-----------|-----------------|
| Monthly backup integrity check | Monthly (automated) | Backup infrastructure is healthy; backups are current |
| Semi-annual DR restore test | Semi-annual (manual, CEO) | Backup files are valid and restorable; data integrity confirmed |

Both are required for S1.5 coverage. The restore test is documented in `docs/08-internal/dr-test-YYYY-QN.md`.

---

## 7. Version History

| Version | Date | Author | Change |
|---------|------|--------|--------|
| 1.0 | 2026-02-27 | Engineering | Initial procedure — Sprint 457 |

---

**Document Owner:** CISO
**Version:** 1.0 — 2026-02-27
