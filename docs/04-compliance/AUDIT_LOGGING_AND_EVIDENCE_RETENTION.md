# Audit Logging and Evidence Retention Policy

**Version:** 1.1
**Document Classification:** Internal
**Effective Date:** February 26, 2026
**Last Updated:** March 1, 2026
**Owner:** Chief Information Security Officer
**Review Cycle:** Quarterly
**Next Review:** May 26, 2026

---

## Executive Summary

This document defines Paciolus's audit logging requirements, event classifications, tamper-resistance controls, retention schedules, and legal hold procedures. It provides the evidentiary framework for security investigations, compliance audits, and regulatory inquiries.

**Key Controls:**
- ✅ 6 event classes with defined retention periods
- ✅ Tamper-resistance via soft-delete immutability model (ORM-enforced)
- ✅ Cryptographic audit chain (HMAC-SHA512 hash chain, SOC 2 CC7.4)
- ✅ Structured JSON logging with request ID correlation
- ✅ PII redaction (email masking, token fingerprinting, exception sanitization)
- ✅ Legal hold process with designated custodian
- ✅ Zero-Storage compliance: no financial data in any log destination

**Target Audience:** Engineering team, compliance officers, auditors, legal counsel

---

## Table of Contents

1. [Scope and Objectives](#1-scope-and-objectives)
2. [Event Classification](#2-event-classification)
3. [Log Format and Content](#3-log-format-and-content)
4. [Sensitive Data Handling](#4-sensitive-data-handling)
5. [Tamper Resistance](#5-tamper-resistance)
6. [Retention Schedule](#6-retention-schedule)
7. [Legal Hold Process](#7-legal-hold-process)
8. [Log Access and Review](#8-log-access-and-review)
9. [Monitoring and Alerting](#9-monitoring-and-alerting)
10. [Contact](#10-contact)

---

## 1. Scope and Objectives

### 1.1 Scope

This policy covers all audit-relevant events generated by:
- Paciolus backend API (FastAPI application)
- Database operations (PostgreSQL, via ORM)
- Authentication and authorization system
- Billing and subscription management
- Infrastructure monitoring (Prometheus, Sentry)
- CI/CD pipeline (GitHub Actions)

### 1.2 Objectives

| Objective | Measurable Target |
|-----------|-------------------|
| Capture all security-relevant events | 100% of authentication, authorization, and data access events logged |
| Prevent log tampering | ORM-level deletion guard on audit models (zero hard-deletes) |
| Protect sensitive data in logs | Zero PII in plaintext logs (email masked, tokens fingerprinted) |
| Retain logs per compliance requirements | Retention windows enforced per Section 6 |
| Support incident investigation | Request ID correlation enables full request tracing |
| Support legal and regulatory inquiries | Legal hold procedure with designated custodian |

---

## 2. Event Classification

### 2.1 Event Classes

| Class | Description | Examples | Retention |
|-------|-------------|----------|-----------|
| **Authentication** | User identity verification events | Login success/failure, token refresh, token revocation, password change, account lockout | 365 days |
| **Authorization** | Access control decisions | Endpoint access denied (403), tier entitlement check, rate limit exceeded (429) | 365 days |
| **Data Access** | Read or write of user-owned data | Client created/updated/deleted, engagement created, diagnostic run, tool execution | 365 days |
| **Administrative** | System configuration and user management | User account deletion, email change, billing event, subscription change | 365 days |
| **Security** | Security-relevant system events | CSRF validation failure, CORS rejection, suspicious input detected, IP blocked | 365 days |
| **Operational** | Infrastructure and performance events | Health check, deployment, database migration, background task execution | 90 days |

### 2.2 Minimum Required Events

The following events **must** be logged. Absence of these events in the log stream constitutes a compliance gap.

#### Authentication Events

| Event | Logged Fields | Log Level |
|-------|-------------|-----------|
| Login success | user_id, email (masked), timestamp, IP | INFO |
| Login failure | email (masked), timestamp, IP, failure_reason | WARNING |
| Account lockout triggered | email (masked), timestamp, failed_attempt_count | WARNING |
| Account lockout expired | email (masked), timestamp | INFO |
| Token refresh | user_id, token_fingerprint (old + new) | INFO |
| Token revocation (logout) | user_id, token_fingerprint | INFO |
| All-token revocation (password change) | user_id | WARNING |
| Token reuse detected | user_id, token_fingerprint | CRITICAL |
| Password change | user_id, timestamp | INFO |
| Email verification | user_id, timestamp, status (success/failure) | INFO |

#### Authorization Events

| Event | Logged Fields | Log Level |
|-------|-------------|-----------|
| Endpoint access denied (401/403) | request_id, path, method, reason | WARNING |
| Tier entitlement denied | user_id, tier, requested_feature | INFO |
| Rate limit exceeded (429) | user_id or IP, endpoint_category, limit | WARNING |
| CSRF validation failure | request_id, path, failure_reason | WARNING |

#### Data Access Events

| Event | Logged Fields | Log Level |
|-------|-------------|-----------|
| Client created/updated/deleted | user_id, client_id, action | INFO |
| Engagement created/updated | user_id, engagement_id, action | INFO |
| Diagnostic run (TB upload + analysis) | user_id, row_count, balanced, anomaly_count, duration_ms | INFO |
| Tool execution | user_id, tool_name, engagement_id (if applicable), duration_ms | INFO |
| Export generated (PDF/CSV/Excel) | user_id, export_type, tool_name | INFO |
| Follow-up item created/updated | user_id, engagement_id, item_id, action | INFO |

#### Administrative Events

| Event | Logged Fields | Log Level |
|-------|-------------|-----------|
| Account deletion | user_id, timestamp | WARNING |
| Email change initiated | user_id, timestamp (old/new emails NOT logged) | INFO |
| Billing event | user_id, event_type, tier | INFO |
| Subscription status change | user_id, old_status, new_status | INFO |

#### Security Events

| Event | Logged Fields | Log Level |
|-------|-------------|-----------|
| CORS origin rejected | request_id, origin | WARNING |
| Malformed request (schema validation) | request_id, path, error_type | WARNING |
| Upload security rejection (formula injection, size limit) | request_id, user_id, rejection_reason | WARNING |
| Suspicious login pattern (>5 failures in window) | IP, email (masked), attempt_count | WARNING |

---

## 3. Log Format and Content

### 3.1 Structured JSON Format (Production)

All production logs are emitted in structured JSON format:

```json
{
  "timestamp": "2026-02-26T10:00:00.000Z",
  "level": "INFO",
  "logger": "routes.auth",
  "message": "User login successful",
  "request_id": "a1b2c3d4e5f6",
  "user_id": "uuid-1234",
  "ip": "203.0.113.42",
  "method": "POST",
  "path": "/auth/login",
  "status_code": 200,
  "duration_ms": 145
}
```

### 3.2 Required Fields

| Field | Description | Presence |
|-------|-------------|----------|
| `timestamp` | ISO 8601 UTC timestamp | Always |
| `level` | Log level (DEBUG, INFO, WARNING, ERROR, CRITICAL) | Always |
| `logger` | Module name (e.g., `routes.auth`, `billing.webhook`) | Always |
| `message` | Human-readable event description | Always |
| `request_id` | Unique request correlation ID (12-char UUID or from `X-Request-ID` header) | All HTTP requests |
| `user_id` | Authenticated user identifier | When authenticated |
| `ip` | Client IP address | All HTTP requests |
| `method` | HTTP method | All HTTP requests |
| `path` | Request path (no query parameters) | All HTTP requests |
| `status_code` | HTTP response status code | All HTTP responses |
| `duration_ms` | Request processing time in milliseconds | All HTTP responses |

### 3.3 Request ID Correlation

Every request receives a unique identifier:
- Source: `X-Request-ID` header (if provided by client/proxy) or auto-generated 12-character UUID
- Propagation: Via `ContextVar`, available to all code in the request lifecycle
- Response: Returned in `X-Request-ID` response header
- Purpose: Enables end-to-end tracing of a single request across log entries

See [SECURITY_POLICY.md](./SECURITY_POLICY.md) Section 8.1 for logging infrastructure details.

---

## 4. Sensitive Data Handling

### 4.1 Data Never Logged

The following data categories are **absolutely excluded** from all log destinations:

| Category | Reason |
|----------|--------|
| Passwords (plaintext or hashed) | Credential exposure risk |
| JWT token bodies | Token theft risk |
| CSRF tokens | Token replay risk |
| Trial balance line items | Zero-Storage compliance |
| Account balances or financial figures | Zero-Storage compliance |
| Database connection strings | Infrastructure security |
| API keys or secrets | Credential exposure risk |

### 4.2 Redaction Rules

| Data Type | Redaction Method | Example |
|-----------|-----------------|---------|
| **Email addresses** | First 3 characters + `***` + `@domain` | `abc***@example.com` |
| **JWT tokens** | First 8 chars + `[` + 8-char SHA-256 prefix + `]` | `eyJhbGci[a1b2c3d4]` |
| **Refresh tokens** | Same as JWT | Fingerprint only |
| **Exception messages** | Class name only (not `str(e)`) | `ValueError` (not the message) |
| **File paths** | Logged as filename only (no full server path) | `upload.csv` |
| **Query parameters** | Stripped from `path` field | `/api/clients` (not `/api/clients?search=acme`) |

All redaction is performed by the `log_sanitizer` module before log emission. See [SECURITY_POLICY.md](./SECURITY_POLICY.md) Section 8.2 for implementation details.

### 4.3 Validation

| Control | Method | Frequency |
|---------|--------|-----------|
| No plaintext credentials in logs | Automated grep scan of log samples | Monthly |
| No financial data in logs | `log_sanitizer` unit tests + Zero-Storage automated checks | Every CI run |
| Email masking functional | Unit tests for `log_sanitizer.mask_email()` | Every CI run |
| Token fingerprinting functional | Unit tests for `log_sanitizer.fingerprint_token()` | Every CI run |

---

## 5. Tamper Resistance

### 5.1 Application-Level Controls

| Control | Implementation | Enforcement |
|---------|---------------|-------------|
| **Soft-delete immutability** | `SoftDeleteMixin` on 5 audit models (ActivityLog, DiagnosticSummary, ToolRun, FollowUpItem, FollowUpItemComment) | ORM `before_flush` event raises `AuditImmutabilityError` on `db.delete()` |
| **No hard-delete API** | No API endpoint performs `DELETE` on audit models | Code review + integration tests |
| **Append-only billing events** | `BillingEvent` table has no update or delete endpoints | Code review + model design |
| **Archived records preserved** | Soft-deleted records excluded from active queries but retained in database | `archived_at IS NULL` filter on all read paths |

### 5.2 Infrastructure-Level Controls

| Control | Implementation |
|---------|---------------|
| **Database access restriction** | No direct developer access to production database (see [Access Control Policy](./ACCESS_CONTROL_POLICY.md) Section 3.1) |
| **Backup integrity** | Database backups include audit tables; point-in-time recovery preserves soft-deleted records |
| **Log aggregator immutability** | Centralized logging service (Datadog/Logtail) with append-only retention |
| **Git audit trail** | All code changes (including logging configuration) tracked in version control |

### 5.3 Tamper Detection

| Indicator | Detection Method |
|-----------|-----------------|
| Gap in sequential log entries | Monitoring alert on missing request IDs in high-traffic endpoints |
| Unexpected `archived_at` timestamps | Periodic audit query comparing soft-delete timestamps against known admin actions |
| Log volume anomaly | Prometheus counter for log events; alert on >50% deviation from 7-day average |
| Direct database modification | pgaudit not available on Render (see Section 5.5); compensating controls via application-layer audit log + cryptographic chain (Section 5.4) |

### 5.4 Cryptographic Audit Chain (Sprint 461)

**SOC 2 CC7.4 Compliance:** Activity log records are linked via an HMAC-SHA512 hash chain that provides cryptographic tamper evidence.

| Property | Detail |
|----------|--------|
| **Algorithm** | HMAC-SHA512 (128-char hex output) |
| **Key** | Application JWT secret key (domain-separated) |
| **Chain structure** | `chain_hash[n] = HMAC(key, chain_hash[n-1] \| serialize(record[n]))` |
| **Genesis** | First record chains from `"0" * 128` (128 hex zeros) |
| **Serialization** | Pipe-delimited fixed-order fields: id, user_id, filename_hash, record_count, total_debits, total_credits, materiality_threshold, was_balanced, anomaly_count, material_count, immaterial_count, is_consolidated, sheet_count, timestamp |
| **Verification** | `GET /audit/chain-verify?start_id=N&end_id=M` (requires verified user) |
| **Backward compatibility** | Pre-Sprint 461 records have `chain_hash = NULL` and are excluded from chain verification |

**Tamper detection capability:** Modification of any field in any record, deletion of a record, or reordering of records will cause the chain verification to fail at the affected record, identifying the exact point of tampering.

### 5.5 Database-Level Audit Logging (pgaudit)

**Status:** Not available on current infrastructure.

Render managed PostgreSQL does **not** support the `pgaudit` extension. This was assessed in Sprint 460 (2026-03-01). See [`docs/08-internal/pgaudit-assessment.md`](../08-internal/pgaudit-assessment.md) for the full assessment, including SOC 2 examiner talking points (CC6.8, CC7.4).

**Compensating controls** are documented in the assessment and summarized in Sections 5.1–5.4 above. The application-layer audit log, ORM deletion guard, structured logging, and cryptographic hash chain collectively provide equivalent tamper-evidence capability for the non-financial metadata stored in this database.

**Future:** If Paciolus migrates to self-managed PostgreSQL (e.g., AWS RDS), pgaudit will be enabled. Configuration is documented in the assessment file.

### 5.6 Other Planned Improvements

| Improvement | Target Date | Status |
|-------------|-------------|--------|
| SIEM integration for centralized correlation | Q3 2026 | Planned |

---

## 6. Retention Schedule

### 6.1 Log Retention by Class

| Log Class | Retention Period | Storage Location | Deletion Method |
|-----------|-----------------|------------------|-----------------|
| **Authentication events** | 365 days | Application logs (aggregator) + database (activity_logs) | Automatic archival after window |
| **Authorization events** | 365 days | Application logs (aggregator) | Automatic rotation |
| **Data access events** | 365 days | Database (activity_logs, diagnostic_summaries, tool_runs) | Soft-delete archival after window |
| **Administrative events** | 365 days | Application logs + database (billing_events) | Automatic archival |
| **Security events** | 365 days | Application logs (aggregator) | Automatic rotation |
| **Operational events** | 90 days | Application logs (aggregator) + Prometheus metrics | Automatic rotation |

### 6.2 Database Record Retention

| Table | Retention | Archival Method | Legal Hold Eligible |
|-------|-----------|-----------------|---------------------|
| `activity_logs` | 365 days | Soft-delete (`archived_at` set after window) | ✅ Yes |
| `diagnostic_summaries` | 365 days | Soft-delete | ✅ Yes |
| `tool_runs` | Until account deletion | Soft-delete | ✅ Yes |
| `follow_up_items` | Until account deletion | Soft-delete | ✅ Yes |
| `billing_events` | Until account deletion | No deletion (append-only) | ✅ Yes |
| `users` | Until account deletion | Hard-delete on user request | ✅ Yes (hold overrides deletion) |

### 6.3 Alignment with Privacy Policy

Retention periods in this policy are aligned with [PRIVACY_POLICY.md](./PRIVACY_POLICY.md) Section 4 (Data Retention Governance). The canonical retention schedule is maintained in the Privacy Policy; this document specifies the logging-specific implementation details.

| Cross-Reference | This Policy | Privacy Policy |
|-----------------|-------------|----------------|
| Activity logs | 365 days (Section 6.1) | 365 days (Section 4.1) |
| Diagnostic summaries | 365 days (Section 6.1) | 365 days (Section 4.1) |
| Financial data | 0 seconds (not logged) | 0 seconds (Section 4.1) |
| Tool sessions | 1–2 hours (automatic expiry) | 1–2 hours (Section 4.1) |

---

## 7. Legal Hold Process

### 7.1 Legal Hold Definition

A legal hold suspends normal retention and deletion schedules for specified data when:
- Litigation is anticipated, pending, or active
- A regulatory investigation is initiated
- A law enforcement request requires data preservation
- An internal investigation requires evidence preservation

### 7.2 Legal Hold Procedure

| Step | Action | Owner | SLA |
|------|--------|-------|-----|
| 1 | Legal counsel issues hold notice specifying scope (users, date range, data types) | Legal | As needed |
| 2 | Hold custodian acknowledges receipt and confirms scope understanding | CISO (Hold Custodian) | 1 business day |
| 3 | Custodian identifies affected data stores (database tables, log aggregator, backups) | CISO + DevOps | 2 business days |
| 4 | Custodian disables automatic archival/deletion for in-scope records | DevOps | 1 business day |
| 5 | Custodian notifies affected data owners (e.g., user deletion requests paused) | CISO | 2 business days |
| 6 | Hold remains active until legal counsel issues release notice | Legal | Duration of matter |
| 7 | On release: custodian re-enables normal retention; records outside normal window are archived | DevOps | 5 business days |

### 7.3 Hold Custodian Responsibilities

| Responsibility | Detail |
|----------------|--------|
| **Preservation** | Ensure no in-scope data is deleted, archived, or modified during hold |
| **Documentation** | Maintain hold log with: hold ID, date issued, scope, data stores affected, date released |
| **Communication** | Notify engineering team of any automated processes that must be paused |
| **GDPR reconciliation** | If a GDPR Article 17 deletion request conflicts with a hold, coordinate with legal to apply the legal obligation exception (GDPR Article 17(3)) |
| **Periodic review** | Quarterly review of active holds with legal to confirm continued necessity |

### 7.4 Hold vs. GDPR Deletion Requests

| Scenario | Resolution |
|----------|------------|
| Deletion request + no active hold | Honor deletion request per Privacy Policy Section 6.3 |
| Deletion request + active hold on user's data | Inform user of legal exception (GDPR Art. 17(3)(e)); delete after hold release |
| Hold issued after deletion request received | If data not yet deleted: place on hold. If already deleted: inform legal that data is unavailable |

### 7.5 Hold Register

All legal holds are tracked in a hold register maintained by the CISO:

| Field | Description |
|-------|-------------|
| Hold ID | Sequential identifier (e.g., `LH-2026-001`) |
| Date issued | Date hold notice received |
| Issuing authority | Legal counsel name/firm |
| Scope description | Users, date range, data types, reason |
| Data stores affected | Specific tables, log ranges, backup sets |
| Status | Active / Released |
| Date released | Date hold was lifted |
| Custodian actions | Log of preservation steps taken |

Register stored in `docs/08-internal/legal-holds/` (access restricted to CISO and legal).

---

## 8. Log Access and Review

### 8.1 Access Permissions

| Role | Access Level | Purpose |
|------|-------------|---------|
| **CISO** | Full read access to all log classes | Security investigations, compliance reviews |
| **DevOps/SRE** | Full read access to operational and security logs | Incident response, monitoring |
| **Senior Engineer** | Read access to application logs during on-call incidents | Incident investigation |
| **Developer** | Read access to staging/development logs only | Debugging |
| **Support** | No direct log access (request via engineering) | Customer issue investigation |
| **Auditor (external)** | Sanitized log extracts provided on request | Compliance audit |

### 8.2 Log Review Schedule

| Review Type | Frequency | Owner | Scope |
|-------------|-----------|-------|-------|
| **Security event review** | Weekly | CISO | Authentication failures, CSRF rejections, rate limit events |
| **Access anomaly review** | Monthly | CISO | Unusual data access patterns, privilege escalation attempts |
| **Retention compliance check** | Quarterly | DevOps | Verify retention windows enforced, no orphaned records |
| **Redaction validation** | Quarterly | CISO | Spot-check production logs for PII leakage |

### 8.3 External Audit Support

When external auditors require log evidence:

| Step | Action | Owner |
|------|--------|-------|
| 1 | Auditor submits evidence request specifying scope and date range | Auditor |
| 2 | CISO reviews request for appropriateness | CISO |
| 3 | DevOps extracts requested logs, applies additional redaction if needed | DevOps |
| 4 | CISO reviews extracted data before handoff | CISO |
| 5 | Sanitized log extract provided to auditor (no raw database access) | CISO |

---

## 9. Monitoring and Alerting

### 9.1 Log-Based Alerts

| Alert | Condition | Severity | Channel |
|-------|-----------|----------|---------|
| **Brute force detection** | >100 login failures per minute | P1 | PagerDuty |
| **Token reuse detected** | Revoked refresh token presented | P0 | PagerDuty |
| **Zero-Storage violation marker** | Financial data detected in log content | P0 | PagerDuty |
| **CSRF failure spike** | >10 CSRF failures per minute | P2 | Slack |
| **Rate limit exhaustion** | >50 rate limit responses per minute | P2 | Slack |
| **Log volume anomaly** | >50% deviation from 7-day average | P3 | Slack |
| **Audit model hard-delete attempt** | `AuditImmutabilityError` raised | P2 | Slack |

### 9.2 Prometheus Metrics

| Metric | Type | Labels |
|--------|------|--------|
| `paciolus_auth_events_total` | Counter | `event_type` (login_success, login_failure, lockout, token_refresh) |
| `paciolus_security_events_total` | Counter | `event_type` (csrf_failure, cors_rejection, rate_limited) |
| `paciolus_parse_events_total` | Counter | `format`, `status` (success, failure) |
| `paciolus_billing_events_total` | Counter | `event_type` |

See [SECURITY_POLICY.md](./SECURITY_POLICY.md) Section 8.4 for Prometheus and Sentry configuration.

---

## 10. Contact

| Role | Contact | Purpose |
|------|---------|---------|
| CISO (Hold Custodian) | security@paciolus.com | Log access requests, legal hold coordination, security reviews |
| DevOps | devops@paciolus.com | Log infrastructure, retention enforcement, extraction requests |
| Legal | legal@paciolus.com | Legal hold notices, regulatory inquiries |
| Compliance | compliance@paciolus.com | Audit support, compliance reviews |

---

## Related Documents

| Document | Relationship |
|----------|-------------|
| [Security Policy](./SECURITY_POLICY.md) | Section 8 (logging infrastructure, redaction, alerting, Prometheus) |
| [Privacy Policy](./PRIVACY_POLICY.md) | Section 4 (canonical retention schedule) |
| [Zero-Storage Architecture](./ZERO_STORAGE_ARCHITECTURE.md) | Data classification (what is/isn't logged) |
| [Incident Response Plan](./INCIDENT_RESPONSE_PLAN.md) | Evidence collection during incidents |
| [Access Control Policy](./ACCESS_CONTROL_POLICY.md) | Log access permissions |

---

**Document Version History:**

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-02-26 | CISO | Initial publication: 6 event classes, minimum required events, structured JSON format, PII redaction rules, soft-delete tamper resistance, retention schedule, legal hold procedure with custodian role, log access permissions |
| 1.1 | 2026-03-01 | CISO | Sprint 460: pgaudit assessment — Section 5.5 documents Render limitation and compensating controls; Section 5.3 updated with cross-reference; pgaudit moved from planned to assessed-not-available |
| 1.2 | 2026-03-01 | Engineering | Sprint 461: Added Section 5.4 (Cryptographic Audit Chain — HMAC-SHA512 hash chain for SOC 2 CC7.4 tamper-resistant evidence); chain-verify API endpoint |

---

*Paciolus — Zero-Storage Trial Balance Diagnostic Intelligence*
