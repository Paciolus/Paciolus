# Paciolus CI Pipeline — Sprint 210 (updated Sprint 411)
# Runs on every push to main and every PR targeting main.
#
# Branch protection recommendation:
#   Settings > Branches > Add rule for "main":
#   - Require status checks: backend-tests, frontend-build, backend-lint,
#     lint-baseline-gate, pip-audit-blocking, npm-audit-blocking, bandit
#   - Require branches to be up to date before merging
#   (CEO decides whether to enforce — this CI just reports.)

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Backend Tests ────────────────────────────────────────────
  backend-tests:
    name: Backend Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: backend/requirements-dev.txt

      - name: Install dependencies
        run: pip install -r requirements-dev.txt

      - name: Create test .env
        run: |
          cat > .env << 'EOF'
          API_HOST=0.0.0.0
          API_PORT=8000
          CORS_ORIGINS=http://localhost:3000
          ENV_MODE=development
          DATABASE_URL=sqlite:///./test.db
          EOF

      - name: Run pytest
        run: pytest tests/ -v --tb=short -q

  # ── Backend Tests (PostgreSQL) ──────────────────────────────
  backend-tests-postgres:
    name: Backend Tests (PostgreSQL 15)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: paciolus
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: paciolus_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U paciolus"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements-dev.txt

      - name: Install dependencies
        run: |
          pip install -r requirements-dev.txt
          pip install psycopg2-binary

      - name: Create test .env
        run: |
          cat > .env << 'EOF'
          API_HOST=0.0.0.0
          API_PORT=8000
          CORS_ORIGINS=http://localhost:3000
          ENV_MODE=development
          DATABASE_URL=sqlite:///./test.db
          EOF

      - name: Run pytest
        env:
          TEST_DATABASE_URL: postgresql://paciolus:testpass@localhost:5432/paciolus_test
        run: pytest tests/ -v --tb=short -q

  # ── Frontend Build ───────────────────────────────────────────
  frontend-build:
    name: Frontend Build + Lint
    runs-on: ubuntu-latest
    outputs:
      eslint_errors: ${{ steps.eslint_count.outputs.eslint_errors }}
      eslint_warnings: ${{ steps.eslint_count.outputs.eslint_warnings }}
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Lint (full report)
        run: |
          npx eslint . > eslint-full-report.txt 2>&1 || true
          tail -5 eslint-full-report.txt

      - name: Count eslint issues
        id: eslint_count
        run: |
          npx eslint . --format json 2>/dev/null | node -e "
            const data = require('fs').readFileSync('/dev/stdin','utf8');
            const files = JSON.parse(data);
            let errors = 0, warnings = 0;
            for (const f of files) {
              for (const m of f.messages || []) {
                if (m.severity === 2) errors++;
                else warnings++;
              }
            }
            console.log('eslint_errors=' + errors);
            console.log('eslint_warnings=' + warnings);
            process.stderr.write('ESLint errors: ' + errors + ' (baseline: 0), warnings: ' + warnings + ' (baseline: 0)\n');
          " >> "$GITHUB_OUTPUT" 2>&1 || true

      - name: Upload eslint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-lint-report
          path: frontend/eslint-full-report.txt
          retention-days: 30

  # ── Backend Lint ─────────────────────────────────────────────
  backend-lint:
    name: Backend Lint (ruff)
    runs-on: ubuntu-latest
    outputs:
      ruff_errors: ${{ steps.ruff_count.outputs.ruff_errors }}
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements-dev.txt

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff (statistics report)
        run: |
          ruff check . --statistics > ruff-statistics.txt 2>&1 || true
          cat ruff-statistics.txt

      - name: Run ruff (full report)
        run: |
          ruff check . --output-format concise > ruff-full-report.txt 2>&1 || true

      - name: Count ruff errors
        id: ruff_count
        run: |
          COUNT=$(ruff check . --output-format json 2>/dev/null | python -c "import json,sys; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")
          echo "ruff_errors=$COUNT" >> "$GITHUB_OUTPUT"
          echo "::notice::Ruff errors: $COUNT (baseline: 0)"

      - name: Upload ruff reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ruff-lint-report
          path: |
            backend/ruff-statistics.txt
            backend/ruff-full-report.txt
          retention-days: 30

  # ── Lint Baseline Gate (no increase) ─────────────────────────
  lint-baseline-gate:
    name: Lint Baseline Gate
    needs: [backend-lint, frontend-build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check ruff baseline
        env:
          RUFF_ERRORS: ${{ needs.backend-lint.outputs.ruff_errors }}
        run: |
          BASELINE=$(python -c "import json; print(json.load(open('.github/lint-baseline.json'))['ruff']['total_errors'])")
          CURRENT="${RUFF_ERRORS:-0}"
          echo "Ruff: current=$CURRENT, baseline=$BASELINE"
          if [ "$CURRENT" -gt "$BASELINE" ]; then
            echo "::error::Ruff errors increased from $BASELINE to $CURRENT. Fix new lint issues before merging."
            exit 1
          fi
          echo "✓ Ruff errors within baseline ($CURRENT ≤ $BASELINE)"

      - name: Check eslint baseline
        env:
          ESLINT_ERRORS: ${{ needs.frontend-build.outputs.eslint_errors }}
          ESLINT_WARNINGS: ${{ needs.frontend-build.outputs.eslint_warnings }}
        run: |
          BASELINE_ERR=$(python -c "import json; print(json.load(open('.github/lint-baseline.json'))['eslint']['total_errors'])")
          BASELINE_WARN=$(python -c "import json; print(json.load(open('.github/lint-baseline.json'))['eslint']['total_warnings'])")
          CURR_ERR="${ESLINT_ERRORS:-0}"
          CURR_WARN="${ESLINT_WARNINGS:-0}"
          echo "ESLint errors: current=$CURR_ERR, baseline=$BASELINE_ERR"
          echo "ESLint warnings: current=$CURR_WARN, baseline=$BASELINE_WARN"
          FAIL=0
          if [ "$CURR_ERR" -gt "$BASELINE_ERR" ]; then
            echo "::error::ESLint errors increased from $BASELINE_ERR to $CURR_ERR."
            FAIL=1
          fi
          if [ "$CURR_WARN" -gt "$BASELINE_WARN" ]; then
            echo "::error::ESLint warnings increased from $BASELINE_WARN to $CURR_WARN."
            FAIL=1
          fi
          if [ "$FAIL" -eq 1 ]; then
            echo "Fix new lint issues before merging."
            exit 1
          fi
          echo "✓ ESLint within baseline (errors: $CURR_ERR ≤ $BASELINE_ERR, warnings: $CURR_WARN ≤ $BASELINE_WARN)"

  # ── SAST: Bandit Security Scanner (blocking) ─────────────────
  bandit:
    name: Security SAST (Bandit)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit (medium+ severity)
        run: bandit -r . -ll --exclude ./tests,./venv -f json -o bandit-report.json || true

      - name: Check for HIGH/CRITICAL findings
        run: |
          python -c "
          import json, sys
          with open('bandit-report.json') as f:
              report = json.load(f)
          high = [r for r in report.get('results', [])
                  if r.get('issue_severity') in ('HIGH',)
                  and r.get('issue_confidence') in ('HIGH', 'MEDIUM')]
          if high:
              print(f'::error::Bandit found {len(high)} HIGH-severity finding(s):')
              for r in high:
                  print(f'  {r[\"filename\"]}:{r[\"line_number\"]} - {r[\"issue_text\"]}')
              sys.exit(1)
          print('No HIGH-severity findings detected.')
          "

  # ── Accounting Policy Gate ───────────────────────────────────
  accounting-policy:
    name: Accounting Policy Gate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run accounting policy guard
        run: python -m guards.accounting_policy_guard

  # ── Dependency Audit: pip (blocking on HIGH/CRITICAL) ────────
  pip-audit-blocking:
    name: Python Dependency Audit (blocking)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install pip-audit and project dependencies
        run: |
          pip install pip-audit
          pip install -r requirements.txt

      - name: Audit for HIGH/CRITICAL vulnerabilities
        run: pip-audit -r requirements.txt

  # ── Dependency Audit: pip (advisory — all severities) ────────
  pip-audit-advisory:
    name: Python Dependency Audit (advisory)
    runs-on: ubuntu-latest
    continue-on-error: true
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install pip-audit and project dependencies
        run: |
          pip install pip-audit
          pip install -r requirements.txt

      - name: Audit all vulnerabilities (advisory)
        run: pip-audit -r requirements.txt --desc

  # ── Dependency Audit: npm (blocking on HIGH/CRITICAL) ────────
  npm-audit-blocking:
    name: Node Dependency Audit (blocking)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Audit for HIGH/CRITICAL vulnerabilities
        run: npm audit --omit=dev --audit-level=high

  # ── Dependency Audit: npm (advisory — all severities) ────────
  npm-audit-advisory:
    name: Node Dependency Audit (advisory)
    runs-on: ubuntu-latest
    continue-on-error: true
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Audit all vulnerabilities (advisory)
        run: npm audit --omit=dev
